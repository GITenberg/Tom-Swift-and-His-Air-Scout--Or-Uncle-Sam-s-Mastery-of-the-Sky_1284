sudo: required
dist: trusty
language: ruby

before_install:
before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install pillow
- sudo pip install cssutils
- sudo pip install docutils
- sudo pip install roman
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
branches:
  only:
  - master
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: jA9PmPRAPDeiwkjLktcsF8X8kJsTyfk1kkxSB9Ud9mvQcXekv7vqVfqgIhWWPfKJdUQEbYEA7mltrXQkNQkDLy1g7/uxLSr3+FSWf4frZV7J/zBQOt2sk5tcYnylP85pcNsd+ph8shh9apgRiCyz6o0WwR3aobWw3QkqSLDY1CxJwYqC42FeALQ//IzIowx4H+YwDHGLTiU1r5H6vpRylBmcA7tNE+xW+eE2QG8TTh9xPx4OGiQfK7bENM08bjL+lU48X2yDh8a9cjNO7NDXO9FlUXGN2RNlKyVqT+yedEFYrq8hTQD+w5CovjiUV2HEZR1sP5ILAGl7eQd2jEWD3xgiJzRyGbpdd/RCrZHl/sHT7dk/UclxgtihcgCpHM74H/27NKXYhIqUzK2oi1pEnI4BUpRH+rpbWlDGNlkBEmqyZ7EdB4oo1X/EiAJjwnGespW1ti64MldCuatQKkQO52Gcu3MhQbaWuZh2umzCuMgMPeWWPnmGI51MCgMRCp+fG0i47dlFZQL8w2/BO77NHRoH7g1A+WUWPRM/q6jOk4udGMr7MwZOsA6ZB4ykKHZhzKMOoXnkcgq8wSTp2uUgzexHaXRtkmens2zJxWhPu9NjoTh6SMjUOgbkWus4dEMjBL1ToYHhld7mP9/qIGBawSRK0cTyqbKAF6p+ln7mTko=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  "on":
    repo: GITenberg/Tom-Swift-and-His-Air-Scout--Or-Uncle-Sam-s-Mastery-of-the-Sky_1284
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy